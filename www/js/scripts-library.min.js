/*!
 * moOde audio player (C) 2014 Tim Curtis
 * http://moodeaudio.org
 *
 * tsunamp player ui (C) 2013 Andrea Coiutti & Simone De Gregori
 * http://www.tsunamp.com
 *
 * This Program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3, or (at your option)
 * any later version.
 *
 * This Program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * 2020-MM-DD TC moOde 7.0.0
 *
 * This is the @chris-rudmin 2019-08-08 rewrite of the library group/filter routines
 * including modifications to all dependant functions and event handlers.
 * Refer to https://github.com/moode-player/moode/pull/16 for more info.
 *
 */
var LIB={albumClicked:!1,recentlyAddedClicked:!1,currentDate:null,totalTime:0,totalSongs:0,artistClicked:"",filters:{artists:[],genres:[],albums:[]}},allGenres=[],allAlbums=[],allSongs=[],allAlbumCovers=[],filteredGenres=[],filteredArtists=[],filteredAlbums=[],filteredSongs=[],filteredSongsDisc=[],filteredAlbumCovers=[],miscLibOptions=[];function loadLibrary(){GLOBAL.libLoading=!0,(miscLibOptions=getMiscLibOptions())[2]=-1!=miscLibOptions[1].indexOf("FolderPath")?"Yes":"No",miscLibOptions[1]=-1!=miscLibOptions[1].indexOf("AlbumID")?"Yes":"No";var e=setTimeout(function(){"tag"!=currentView&&"album"!=currentView||notify("library_loading")},2e3);$.post("command/moode.php?cmd=loadlib",function(t){clearTimeout(e),$("#lib-content").show(),renderLibrary(t),"album"!=currentView&&"tag"!=currentView||setLibMenuAndHeader(),GLOBAL.libRendered=!0,GLOBAL.libLoading=!1},"json")}function renderLibrary(e){groupLib(e),filterLib(),LIB.totalSongs=allSongs.length,renderGenres()}function reduceGenres(e,t){for(i=0;i<t.genre.length;i++){var r=t.genre[i].toLowerCase();e[r]||(e[r]=[],e[r].genre=t.genre[i]),e[r].push(t)}return e}function reduceArtists(e,t){if(t.album_artist){if(e[r=t.album_artist.toLowerCase()]||(e[r]=[],e[r].artist=t.album_artist),e[r].push(t),"Artist"!=SESSION.json.library_tagview_artist)return e}else var r=null;if(t.artist)for(var i=0;i<t.artist.length;i++){var s=t.artist[i].toLowerCase();s!=r&&(e[s]||(e[s]=[],e[s].artist=t.artist[i]),e[s].push(t))}return e}function reduceAlbums(e,t){var r=t.key;return e[r]||(e[r]=[]),e[r].push(t),e}function findAlbumProp(e,t){var r=e.find(function(e){return e[t]});return r&&r[t]}function getLastModified(e){var t=e.map(function(e){return new Date(e.last_modified)});return new Date(Math.max.apply(null,t))}function getYear(e){var t=e.map(function(e){return e.year});return Math.max.apply(null,t)}function getAlbumArtist(e){var t;return 1==(t=e.reduce(function(e,t){return!e.includes(t.album_artist)&&e.push(t.album_artist),e},[])).length?t[0]:"Various"}function groupLib(e){allSongs=e.map(function(e){var t=e;return t.key=keyAlbum(e),t}),(allGenres=Object.values(allSongs.reduce(reduceGenres,{})).map(function(e){return e.genre})).sort(),allAlbums=Object.values(allSongs.reduce(reduceAlbums,{})).map(function(e){var t=findAlbumProp(e,"file"),r=void 0===t?0:$.md5(t.substring(0,t.lastIndexOf("/"))),i=getYear(e);return{key:findAlbumProp(e,"key"),last_modified:getLastModified(e),year:i,album:findAlbumProp(e,"album"),mb_albumid:findAlbumProp(e,"mb_albumid"),genre:findAlbumProp(e,"genre"),all_genres:Object.keys(e.reduce(reduceGenres,{})),album_artist:getAlbumArtist(e),imgurl:"/imagesw/thmcache/"+encodeURIComponent(r)+".jpg",encoded_at:findAlbumProp(e,"encoded_at"),comment:findAlbumProp(e,"comment")}}),allAlbumCovers=allAlbums.slice();var t=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});switch(allSongs.sort(function(e,r){return t.compare(removeArticles(e.album_artist),removeArticles(r.album_artist))}),SESSION.json.library_albumview_sort){case"Album":allAlbumCovers.sort(function(e,r){return t.compare(removeArticles(e.album),removeArticles(r.album))});break;case"Artist":allAlbumCovers.sort(function(e,r){return t.compare(removeArticles(e.album_artist),removeArticles(r.album_artist))||t.compare(removeArticles(e.album),removeArticles(r.album))});break;case"Artist/Year":allAlbumCovers.sort(function(e,r){return t.compare(removeArticles(e.album_artist),removeArticles(r.album_artist))||t.compare(e.year,r.year)});break;case"Year":allAlbumCovers.sort(function(e,r){return t.compare(e.year,r.year)||t.compare(removeArticles(e.album),removeArticles(r.album))})}switch(SESSION.json.library_tagview_sort){case"Album":case"Album/Year":allAlbums.sort(function(e,r){return t.compare(removeArticles(e.album),removeArticles(r.album))});break;case"Artist":allAlbums.sort(function(e,r){return t.compare(removeArticles(e.album_artist),removeArticles(r.album_artist))||t.compare(removeArticles(e.album),removeArticles(r.album))});break;case"Artist/Year":allAlbums.sort(function(e,r){return t.compare(removeArticles(e.album_artist),removeArticles(r.album_artist))||t.compare(e.year,r.year)});break;case"Year":allAlbums.sort(function(e,r){return t.compare(e.year,r.year)||t.compare(removeArticles(e.album),removeArticles(r.album))})}}function filterByGenre(e){var t=e.genre.map(function(e){return e.toLowerCase()});return result=LIB.filters.genres.find(function(e){return t.find(function(t){return t==e.toLowerCase()})}),result}function filterByAllGenres(e){return LIB.filters.genres.find(function(t){return e.all_genres.includes(t.toLowerCase())})}function filterByArtist(e){if("Album Artist"==SESSION.json.library_tagview_artist){var t=e.album_artist.toLowerCase();return LIB.filters.artists.find(function(e){var r=e.toLowerCase();return t===r})}var r=e.artist.map(function(e){return e.toLowerCase()});return r.push(e.album_artist.toLowerCase()),result=LIB.filters.artists.find(function(e){return r.find(function(t){return t===e.toLowerCase()})}),result}function filterByAlbum(e){return LIB.filters.albums.includes(e.key)}function filterAlbumsByDate(e){return LIB.currentDate.getTime()-e.last_modified.getTime()<=parseInt(SESSION.json.library_recently_added)}function filterSongsByDate(e){return itemDateObj=new Date(e.last_modified),LIB.currentDate.getTime()-itemDateObj.getTime()<=parseInt(SESSION.json.library_recently_added)}function filterArtists(){var e=allSongs;LIB.filters.genres.length&&(e=e.filter(filterByGenre)),filteredArtists=Object.values(e.reduce(reduceArtists,{})).map(function(e){return e.artist});var t=[];filteredArtists.forEach(e=>{t=t.concat(e)}),filteredArtists=t.slice();var r=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});filteredArtists.sort(function(e,t){return r.compare(removeArticles(e).toLowerCase(),removeArticles(t).toLowerCase())})}function filterAlbums(){if(filteredAlbums=allAlbums,filteredAlbumCovers=allAlbumCovers,LIB.filters.genres.length&&(filteredAlbums=filteredAlbums.filter(filterByAllGenres),filteredAlbumCovers=filteredAlbumCovers.filter(filterByAllGenres)),LIB.filters.artists.length){var e=allSongs.filter(filterByArtist).map(function(e){return e.key});filteredAlbums=filteredAlbums.filter(function(t){return e.includes(keyAlbum(t))}),filteredAlbumCovers=filteredAlbumCovers.filter(function(t){return e.includes(keyAlbum(t))})}if(LIB.recentlyAddedClicked){LIB.currentDate=new Date,filteredAlbums=filteredAlbums.filter(filterAlbumsByDate),filteredAlbumCovers=filteredAlbumCovers.filter(filterAlbumsByDate);var t=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});filteredAlbums.sort(function(e,r){return t.compare(r.last_modified.getTime(),e.last_modified.getTime())}),filteredAlbumCovers.sort(function(e,r){return t.compare(r.last_modified.getTime(),e.last_modified.getTime())})}}function filterSongs(){filteredSongs=allSongs,LIB.filters.genres.length&&(filteredSongs=filteredSongs.filter(filterByGenre)),LIB.filters.artists.length&&(filteredSongs=filteredSongs.filter(filterByArtist)),LIB.filters.albums.length&&(filteredSongs=filteredSongs.filter(filterByAlbum)),LIB.recentlyAddedClicked&&(filteredSongs=filteredSongs.filter(filterSongsByDate))}function filterLib(){filteredSongsDisc.length=0,filterArtists(),filterAlbums(),filterSongs()}function removeArticles(e){return"None"!=SESSION.json.library_ignore_articles?e.replace(GLOBAL.regExIgnoreArticles,"$2"):e}function keyAlbum(e){if("Nothing found"!=e.album){if("Yes"==miscLibOptions[2]){if(void 0!==e.file)var t=$.md5(e.file.substring(0,e.file.lastIndexOf("/")));else if(void 0!==e.imgurl)t=e.imgurl.substring(e.imgurl.lastIndexOf("/")+1,e.imgurl.indexOf(".jpg"));return e.album.toLowerCase()+"@"+t+"@"+e.mb_albumid}return e.album.toLowerCase()+"@"+(e.album_artist||e.artist).toLowerCase()+"@"+e.mb_albumid}}function parseSongTime(e){var t=parseInt(e);return isNaN(t)?0:t}function makeCoverUrl(e){return"/coverart.php/"+encodeURIComponent(e)}function clickedLibItem(e,t,r,i){null==t?r.length=0:e.ctrlKey||e.metaKey?(currentIndex=r.indexOf(t),currentIndex>=0?r.splice(currentIndex,1):r.push(t)):(r.length=0,r.push(t)),filterLib(),"Album/Year"==SESSION.json.library_tagview_sort&&1==LIB.artistClicked&&filteredAlbums.sort(function(e,t){return parseInt(e.year)-parseInt(t.year)}),i()}Object.values||Object.defineProperty(Object,"values",{configurable:!0,enumerable:!1,value:function(e){return Object.keys(e).map(function(t){return e[t]})},writable:!0});var renderGenres=function(){for(var e="",t=0;t<allGenres.length;t++)e+='<li class="lib-entry'+(LIB.filters.genres.indexOf(allGenres[t])>=0?" active":"")+'">'+allGenres[t]+"</li>";document.getElementById("genresList").innerHTML=e,-2==UI.libPos[0]&&$("#lib-genre").scrollTo(0,200),renderArtists()},renderArtists=function(){for(var e="",t=0;t<filteredArtists.length;t++)e+='<li class="lib-entry'+(LIB.filters.artists.indexOf(filteredArtists[t])>=0||1==filteredArtists.length?" active":"")+'">'+filteredArtists[t]+"</li>";document.getElementById("artistsList").innerHTML=e,-2==UI.libPos[0]&&$("#lib-artist").scrollTo(0,200),renderAlbums()},renderAlbums=function(){var e="",t="",r="",i="";if(GLOBAL.nativeLazyLoad)var s='<img loading="lazy" src="',l='<div class="thumbHW"><img loading="lazy" src="';else s='<img class="lazy-tagview" data-original="',l='<div class="thumbHW"><img class="lazy-albumview" data-original="';for(var a=parseInt(SESSION.json.library_encoded_at),n="",o="",d="",c="",m="",u="",b=0;b<filteredAlbums.length;b++){if(r=filteredAlbums[b].year?"("+filteredAlbums[b].year+")":"",i=filteredAlbumCovers[b].year?"("+filteredAlbumCovers[b].year+")":"",a&&9!=a){n=1==a&&"h"==filteredAlbums[b].encoded_at.split(",")[1]?'<div class="lib-encoded-at-hdonly-tagview">'+ALBUM_HD_BADGE_TEXT+"</div>":"",o=a<=1?'<div class="lib-encoded-at-notvisible">'+filteredAlbums[b].encoded_at.split(",")[0]+"</div>":"";var f=filteredAlbumCovers[b].encoded_at.split(",");d=a<=1?'<div class="lib-encoded-at-notvisible">'+filteredAlbumCovers[b].encoded_at.split(",")[0]+"</div>":"",c=1==a&&"h"==f[1]?'<div class="lib-encoded-at-hdonly">'+ALBUM_HD_BADGE_TEXT+"</div>":"",m=2==a?'<div class="lib-encoded-at-text">'+f[0]+"</div>":"",u=3==a?'<div class="lib-encoded-at-badge">'+f[0]+"</div>":""}"Yes"==SESSION.json.library_tagview_covers?e+='<li class="lib-entry">'+s+filteredAlbums[b].imgurl+'">'+n+'<div class="tag-cover-text"><span class="album-name-art">'+filteredAlbums[b].album+'</span><span class="artist-name-art">'+filteredAlbums[b].album_artist+'</span><span class="album-year">'+r+"</span></div>"+o+"</li>":e+='<li class="lib-entry no-tagview-covers"><span class="album-name">'+filteredAlbums[b].album+'</span><span class="artist-name-art">'+filteredAlbums[b].album_artist+'</span><span class="album-year">'+r+"</span></li>",t+='<li class="lib-entry">'+l+filteredAlbumCovers[b].imgurl+'"></div><div class="cover-menu" data-toggle="context" data-target="#context-menu-lib-album"></div>'+c+u+'<span class="album-name">'+filteredAlbumCovers[b].album+'</span><div class="artyear"><span class="artist-name">'+filteredAlbumCovers[b].album_artist+'</span><span class="album-year">'+i+"</span></div>"+m+d+"</li>"}document.getElementById("albumsList").innerHTML=e,document.getElementById("albumcovers").innerHTML=t,1==filteredAlbums.length&&($("#albumsList li").addClass("active"),LIB.albumClicked=!0,UI.libPos[0]=0),"Yes"==SESSION.json.library_ellipsis_limited_text&&$("#library-panel, #radio-panel").addClass("limited"),-2==UI.libPos[0]&&($(".tag-view-btn").hasClass("active")?$("#lib-album").scrollTo(0,200):$("#lib-albumcover").scrollTo(0,200)),$(".album-view-btn").hasClass("active")?$("img.lazy-albumview").lazyload({container:$("#lib-albumcover")}):$(".tag-view-btn").hasClass("active")&&"Yes"==SESSION.json.library_tagview_covers&&$("img.lazy-tagview").lazyload({container:$("#lib-album")}),renderSongs()},renderSongs=function(e){var t="",r="",s="",l="",a="";LIB.totalTime=0;var n=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});if(filteredSongs.sort(function(e,t){return n.compare(e.key,t.key)||n.compare(e.disc,t.disc)||n.compare(e.tracknum,t.tracknum)}),1==LIB.artistClicked||1==LIB.albumClicked){var o=[];if(1==LIB.albumClicked)for(j=0;j<filteredSongs.length;j++)filteredSongs[j].key==filteredAlbums[UI.libPos[0]].key&&o.push(filteredSongs[j]);else for(i=0;i<filteredAlbums.length;i++)for(j=0;j<filteredSongs.length;j++)filteredSongs[j].key==filteredAlbums[i].key&&o.push(filteredSongs[j]);filteredSongs=o,r="",s="";var d=[];for(i=0;i<filteredSongs.length;i++)filteredSongs[i].album==r&&filteredSongs[i].disc!=s&&d.push(filteredSongs[i].album),r=filteredSongs[i].album,s=filteredSongs[i].disc;for(r="",s="",i=0;i<filteredSongs.length;i++){var c=filteredSongs[i].year?filteredSongs[i].year.slice(0,4):" ";if("Yes"==miscLibOptions[0])var m=""!=filteredSongs[i].comment?" ("+filteredSongs[i].comment+")":"";else if("Yes"==miscLibOptions[1])m="0"!=filteredSongs[i].mb_albumid?" ("+filteredSongs[i].mb_albumid.slice(0,8)+")":"";else m="";(f=filteredSongs[i].album+m)!=r?(l='<div class="lib-album-heading">'+f+"</div>",r=f):l="",-1!=d.indexOf(filteredSongs[i].album)&&(filteredSongs[i].disc!=s?(a='<div id="lib-disc-'+filteredSongs[i].disc+'" class="lib-disc"><a class="btn" href="#notarget" data-toggle="context" data-target="#context-menu-lib-disc">Disc '+filteredSongs[i].disc+"</a></div>",s=filteredSongs[i].disc):a="");var u="Composer tag missing"==filteredSongs[i].composer?"</span>":'<br><span class="songcomposer">'+filteredSongs[i].composer+"</span></span>",b=filteredSongs[i].title==MPD.json.title&&filteredSongs[i].album==MPD.json.album&&"play"==MPD.json.state?" lib-track-highlight":"";t+=l+a+'<li id="lib-song-'+(i+1)+'" class="clearfix lib-track" data-toggle="context" data-target="#context-menu-lib-item"><div class="lib-entry-song"><span class="songtrack'+b+'">'+filteredSongs[i].tracknum+'</span><span class="songname">'+filteredSongs[i].title+'</span><span class="songtime"> '+filteredSongs[i].time_mmss+'</span><span class="songartist"> '+filteredSongs[i].artist.join(", ")+u+'<span class="songyear"> '+c+"</span></div></li>",LIB.totalTime+=parseSongTime(filteredSongs[i].time)}}else for(i=0;i<filteredSongs.length;i++)LIB.totalTime+=parseSongTime(filteredSongs[i].time);if(document.getElementById("songsList").innerHTML=t,(filteredAlbums.length>1&&1==LIB.artistClicked&&0==LIB.albumClicked||"0"!=filteredSongs[0].mb_albumid)&&$(".lib-album-heading").css("display","block"),s>1&&!filteredSongs[0].album.toLowerCase().includes("[disc")&&$(".lib-disc").css("display","block"),1==filteredAlbums.length||LIB.filters.albums.length||void 0!==e)$("#lib-coverart-img").html('<a href="#notarget" data-toggle="context" data-target="#context-menu-lib-album"><img class="lib-coverart" src="'+makeCoverUrl(filteredSongs[0].file)+'" alt="Cover art not found"></a>'),$("#lib-albumname").html(filteredSongs[0].album),g=e&&!UI.libPos[0]?filteredAlbums[UI.libPos[0]].album_artist:filteredSongs[0].album_artist,"Nothing found"==filteredSongs[0].album?($("#lib-artistname, #lib-albumyear, #lib-numtracks, #lib-encoded-at").html(""),$("#lib-coverart-img a, .cover-menu").attr("data-target","#")):($("#lib-artistname").html(g),$("#lib-albumyear").html(filteredSongs[0].year),$("#lib-numtracks").html(filteredSongs.length+(1==filteredSongs.length?" track, ":" tracks, ")+formatLibTotalTime(LIB.totalTime)),$("#lib-encoded-at").html(filteredSongs[0].encoded_at.split(",")[0]));else{var f=LIB.filters.genres.length?LIB.filters.genres:LIB.filters.artists.length?LIB.filters.artists:"Music Library",g=LIB.filters.genres.length?LIB.filters.artists:"";if(LIB.filters.artists.length>0){var p=1==LIB.filters.artists.length?LIB.filters.artists[0]:"Multiple Artists Selected";$("#lib-coverart-img").html('<img class="lib-artistart" src="'+makeCoverUrl(filteredSongs[0].file)+'" alt="Cover art not found"><button class="btn" id="tagview-text-cover" data-toggle="context" data-target="#context-menu-lib-album">'+p+"</button>"),g=""}else if(LIB.filters.genres.length>0){var y=1==LIB.filters.genres.length?LIB.filters.genres[0]:"Multiple Genres Selected";$("#lib-coverart-img").html('<button class="btn" id="tagview-text-cover" data-toggle="context" data-target="#context-menu-lib-album">'+y+"</button>")}else{if("full_lib"!=SESSION.json.library_flatlist_filter)var v='<div id="lib-flatlist-filter"><i class="far fa-filter"></i> Filtered</div>';else v="";$("#lib-coverart-img").html('<button class="btn" id="tagview-text-cover" data-toggle="context" data-target="#context-menu-lib-album">Music Collection'+v+"</button>")}$("#lib-albumname").html(f),$("#lib-artistname").html(g),$("#lib-albumyear").html(""),$("#lib-numtracks").html(formatNumCommas(filteredAlbums.length)+" albums<br>"+formatNumCommas(filteredSongs.length)+(1==filteredSongs.length?" track<br>":" tracks<br>")+formatLibTotalTime(LIB.totalTime)),$("#lib-encoded-at").html("")}};function oneTouchItem(e){if("No action"!=SESSION.json.library_instant_play)if("Add"==SESSION.json.library_instant_play||"Add next"==SESSION.json.library_instant_play){var t="Add"==SESSION.json.library_instant_play?"add_item":"add_item_next";mpdDbCmd(t,e),notify(t)}else if("Play"==SESSION.json.library_instant_play||"Play next"==SESSION.json.library_instant_play){t="Play"==SESSION.json.library_instant_play?"play_item":"play_item_next";mpdDbCmd(t,e)}else"Clear/Play"==SESSION.json.library_instant_play&&(mpdDbCmd("clear_play_item",e),notify("clear_play_item"))}function oneTouchGroup(e){if("No action"!=SESSION.json.library_instant_play)if("Add"==SESSION.json.library_instant_play||"Add next"==SESSION.json.library_instant_play){var t="Add"==SESSION.json.library_instant_play?"add_group":"add_group_next";mpdDbCmd(t,e),notify(t)}else if("Play"==SESSION.json.library_instant_play||"Play next"==SESSION.json.library_instant_play){t="Play"==SESSION.json.library_instant_play?"play_group":"play_group_next";mpdDbCmd(t,e)}else"Clear/Play"==SESSION.json.library_instant_play&&(mpdDbCmd("clear_play_group",e),notify("clear_play_group"))}function formatLibTotalTime(e){var t,r,i,s,l;return isNaN(parseInt(e))?t="":(s=0==(r=~~(e/3600))?"":1==r?r+" hour":r+" hours",l=0==(i=~~((e%=3600)/60))?"":1==i?i+" min":i+" mins",t=r>0?i>0?s+" "+l:s:l),formatNumCommas(t)}function formatNumCommas(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}$("#genreheader, #menu-header").on("click",function(e){"full_lib"==SESSION.json.library_flatlist_filter||0!=$(e.target).parent("#genreheader").length||"all"!=GLOBAL.musicScope?("tag"==currentView||"album"==currentView?(LIB.filters.genres.length=0,LIB.filters.artists.length=0,LIB.filters.albums.length=0,LIB.artistClicked=!1,LIB.albumClicked=!1,$("#tracklist-toggle").html('<i class="fal fa-list sx"></i> Show tracks'),""!=$("#lib-album-filter").val()?$("#searchResetLib").show():($("#searchResetLib").hide(),showSearchResetLib=!1),"recent"==GLOBAL.musicScope&&(GLOBAL.musicScope="all"),"album"==currentView&&($("#albumcovers .lib-entry").removeClass("active"),$("#bottom-row").css("display",""),$("#lib-albumcover").css("height","100%")),setLibMenuAndHeader()):"radio"==currentView&&(GLOBAL.searchRadio="",$("#searchResetRa").click(),setLibMenuAndHeader()),UI.libPos.fill(-2),storeLibPos(UI.libPos),clickedLibItem(e,void 0,LIB.filters.genres,renderGenres)):applyLibFilter("full_lib")}),$("#artistheader").on("click",".lib-heading",function(e){LIB.artistClicked=!1,LIB.albumClicked=!1,LIB.filters.artists.length=0,LIB.filters.albums.length=0,UI.libPos.fill(-2),storeLibPos(UI.libPos),clickedLibItem(e,void 0,LIB.filters.artists,renderArtists),setLibMenuAndHeader()}),$("#albumheader").on("click",".lib-heading",function(e){LIB.albumClicked=!1,LIB.filters.albums.length=0,UI.libPos[0]=-2,UI.libPos[1]=-2,clickedLibItem(e,void 0,LIB.filters.albums,renderAlbums),storeLibPos(UI.libPos)}),$("#genresList").on("click",".lib-entry",function(e){var t=$("#genresList .lib-entry").index(this);LIB.artistClicked=!1,LIB.albumClicked=!1,LIB.filters.artists.length=0,LIB.filters.albums.length=0,UI.libPos[0]=-1,storeLibPos(UI.libPos),clickedLibItem(e,allGenres[t],LIB.filters.genres,renderGenres),setLibMenuAndHeader()}),$("#artistsList").on("click",".lib-entry",function(e){var t=$("#artistsList .lib-entry").index(this);UI.libPos[0]=-1,UI.libPos[2]=t,LIB.filters.albums.length=0,storeLibPos(UI.libPos),LIB.artistClicked=!0,LIB.albumClicked=!1,clickedLibItem(e,filteredArtists[t],LIB.filters.artists,renderArtists),UI.mobile&&$("#top-columns").animate({left:"-50%"},200),setLibMenuAndHeader()}),$("#albumsList").on("click",".lib-entry",function(e){var t=$("#albumsList .lib-entry").index(this);LIB.albumClicked=!0,UI.libPos[0]=t,UI.libPos[1]=filteredAlbumCovers.map(function(e){return e.key}).indexOf(filteredAlbums[t].key);var r=filteredAlbums[t],i=filteredAlbums[t].album,s=this.className.includes("active");if(storeLibPos(UI.libPos),$("#albumsList .lib-entry").removeClass("active"),$("#albumsList .lib-entry").eq(t).addClass("active"),s&&LIB.filters.artists.length&&!LIB.filters.artists.includes(r.album_artist))if("Yes"==miscLibOptions[2]){var l=allSongs.filter(e=>e.key===r.key);if(filteredSongs.length<l.length){var a=l.map(e=>e.album_artist),n=LIB.filters.artists.length;a.forEach(e=>!LIB.filters.artists.includes(e)&&LIB.filters.artists.push(e)),filterSongs(),LIB.filters.artists=LIB.filters.artists.slice(0,n),filteredSongs.sort((e,t)=>e.tracknum-t.tracknum).sort((e,t)=>e.disc-t.disc),renderSongs()}else filterSongs(),renderSongs()}else{var o=filteredSongs.map(function(e){return e.artist}),d=!1,c=[];LIB.filters.artists.forEach(e=>{c=c.concat(e)});for(let e of o){var m=0;for(let t of c)e.includes(t)&&m++;if(0==m){d=!0;break}}d?(filterSongs(),renderSongs()):(LIB.filters.artists.push(r.album_artist),filterSongs(),LIB.filters.artists.pop(),renderSongs())}else clickedLibItem(e,keyAlbum(r),LIB.filters.albums,renderSongs);$("#bottom-row").css("display","flex"),$("#lib-file").scrollTo(0,200),UI.libAlbum=i}),$("#random-album").click(function(e){$("#albumsList .lib-entry").eq(UI.libPos[0]).removeClass("active"),$("#albumcovers .lib-entry").eq(UI.libPos[1]).removeClass("active");var t=new Uint16Array(1);if(LIB.albumClicked=!0,window.crypto.getRandomValues(t),pos=Math.floor(t[0]/65535*filteredAlbums.length),"tag"==currentView){var r="#albumsList .lib-entry",i="albums";UI.libPos[0]=pos,UI.libPos[1]=filteredAlbumCovers.map(function(e){return e.key}).indexOf(filteredAlbums[pos].key);var s=filteredAlbums[pos]}else{r="#albumcovers .lib-entry",i="albumcovers";UI.libPos[0]=filteredAlbums.map(function(e){return e.key}).indexOf(filteredAlbumCovers[pos].key),UI.libPos[1]=pos;s=filteredAlbumCovers[pos]}storeLibPos(UI.libPos),$(r).eq(pos).addClass("active"),customScroll(i,pos,0),clickedLibItem(e,keyAlbum(s),LIB.filters.albums,renderSongs)}),$("#albumcovers").on("click",".cover-menu",function(e){var t=$(this).parents("li").index();LIB.albumClicked=!0,$("#albumcovers .lib-entry").eq(UI.libPos[1]).removeClass("active"),$("#tracklist-toggle").show(),$("#one-touch-action-li").hide(),UI.libPos[0]=filteredAlbums.map(function(e){return e.key}).indexOf(filteredAlbumCovers[t].key),UI.libPos[1]=t,storeLibPos(UI.libPos),$("#albumcovers .lib-entry").eq(UI.libPos[1]).addClass("active"),clickedLibItem(e,keyAlbum(filteredAlbumCovers[t]),LIB.filters.albums,renderSongs)}),$("#albumcovers").on("click","img",function(e){var t=$(this).parents("li").index();LIB.albumClicked=!0,$("#albumcovers .lib-entry").eq(UI.libPos[1]).removeClass("active"),UI.libPos[0]=filteredAlbums.map(function(e){return e.key}).indexOf(filteredAlbumCovers[t].key),UI.libPos[1]=t,storeLibPos(UI.libPos),$("#albumcovers .lib-entry").eq(UI.libPos[1]).addClass("active"),clickedLibItem(e,keyAlbum(filteredAlbumCovers[t]),LIB.filters.albums,renderSongs);var r=[];for(var i in filteredSongs)r.push(filteredSongs[i].file);if("No action"!=SESSION.json.library_instant_play)if("Add"==SESSION.json.library_instant_play||"Add next"==SESSION.json.library_instant_play){var s="Add"==SESSION.json.library_instant_play?"add_group":"add_group_next";mpdDbCmd(s,r),notify(s)}else if("Play"==SESSION.json.library_instant_play||"Play next"==SESSION.json.library_instant_play){s="Play"==SESSION.json.library_instant_play?"play_group":"play_group_next";mpdDbCmd(s,r)}else"Clear/Play"==SESSION.json.library_instant_play&&(mpdDbCmd("clear_play_group",r),notify("clear_play_group"));return!1}),$(".ralbum").click(function(e){if("No action"!=SESSION.json.library_instant_play){$("#albumsList .lib-entry").eq(UI.libPos[0]).removeClass("active"),$("#albumcovers .lib-entry").eq(UI.libPos[1]).removeClass("active"),$(".ralbum svg").attr("class","spin"),setTimeout(function(){$(".ralbum svg").attr("class","")},RALBUM_TIMEOUT);var t=new Uint16Array(1);LIB.albumClicked=!0,window.crypto.getRandomValues(t),pos=Math.floor(t[0]/65535*filteredAlbums.length),UI.libPos[0]=pos,UI.libPos[1]=filteredAlbumCovers.map(function(e){return e.key}).indexOf(filteredAlbums[pos].key),clickedLibItem(e,keyAlbum(filteredAlbums[pos]),LIB.filters.albums,renderSongs);var r=[];for(var i in filteredSongs)r.push(filteredSongs[i].file);if("Add"==SESSION.json.library_instant_play||"Add next"==SESSION.json.library_instant_play){var s="Add"==SESSION.json.library_instant_play?"add_group":"add_group_next";mpdDbCmd(s,r),notify(s)}else if("Play"==SESSION.json.library_instant_play||"Play next"==SESSION.json.library_instant_play){s="Play"==SESSION.json.library_instant_play?"play_group":"play_group_next";mpdDbCmd(s,r)}else"Clear/Play"==SESSION.json.library_instant_play&&mpdDbCmd("clear_play_group",r);storeLibPos(UI.libPos)}}),$("#database-radio").on("click","img",function(e){var t=$(this).parents("li").index(),r=$(this).parents("li").data("path");UI.radioPos=t,storeRadioPos(UI.radioPos),"ra-"==UI.dbEntry[3].substr(0,3)&&$("#"+UI.dbEntry[3]).removeClass("active"),UI.dbEntry[3]=$(this).parents("li").attr("id"),$(this).parents("li").addClass("active"),oneTouchItem(r),setTimeout(function(){customScroll("radio",UI.radioPos+1,200)},DEFAULT_TIMEOUT)}),$("#radio-manager-btn").click(function(e){var t=SESSION.json.radioview_sort_group.split(","),r=SESSION.json.radioview_show_hide.split(",");if($("#radioview-sort-tag span").text(t[0]),$("#radioview-group-method span").text(t[1]),$("#radioview-show-hide-moode span").text(r[0]),$("#radioview-show-hide-other span").text(r[1]),$("#import-export-msg").text(""),SESSION.json.feat_bitmask&FEAT_RECORDER){if("Not installed"==SESSION.json.recorder_status)var i='<li class="modal-dropdown-text"><a href="#notarget" data-cmd="recorder-status-sel"><span class="text">Not installed</span></a></li><li class="modal-dropdown-text"><a href="#notarget" data-cmd="recorder-status-sel"><span class="text">Install recorder</span></a></li>';else i='<li class="modal-dropdown-text"><a href="#notarget" data-cmd="recorder-status-sel"><span class="text">On</span></a></li><li class="modal-dropdown-text"><a href="#notarget" data-cmd="recorder-status-sel"><span class="text">Off</span></a></li>';$("#recorder-status-list").html(i),$("#recorder-status span").text(SESSION.json.recorder_status),$.getJSON("command/recorder_cmd.php?cmd=recorder_storage_paths",function(e){$("#recorder-storage-list").html(e),$("#recorder-storage span").text(SESSION.json.recorder_storage)}),$("#radio-manager-modal").modal()}else $("#radio-manager-modal").modal()}),$("#btn-upd-radio-manager").click(function(e){if(SESSION.json.radioview_sort_group=$("#radioview-sort-tag span").text()+","+$("#radioview-group-method span").text(),SESSION.json.radioview_show_hide=$("#radioview-show-hide-moode span").text()+","+$("#radioview-show-hide-other span").text(),SESSION.json.feat_bitmask&FEAT_RECORDER){var t=$("#recorder-status span").text(),r=SESSION.json.recorder_status!=t,i=SESSION.json.recorder_storage!=$("#recorder-storage span").text();SESSION.json.recorder_status="Install recorder"==$("#recorder-status span").text()||!0===i?"Off":$("#recorder-status span").text(),SESSION.json.recorder_storage=$("#recorder-storage span").text()}$.post("command/moode.php?cmd=updcfgsystem",{radioview_sort_group:SESSION.json.radioview_sort_group,radioview_show_hide:SESSION.json.radioview_show_hide,recorder_status:SESSION.json.recorder_status,recorder_storage:SESSION.json.recorder_storage},function(){setTimeout(function(){$("#ra-refresh").click()},DEFAULT_TIMEOUT),"Install recorder"==t?$.ajax({type:"GET",url:"command/recorder_cmd.php?cmd=recorder_install",dataType:"json",async:!0,cache:!1,success:function(e){"recorder_installed"==e&&($("#stream-recorder-options").show(),$("#context-menu-stream-recorder").show()),notify(e)},error:function(){SESSION.json.recorder_status="Not installed",$.post("command/moode.php?cmd=updcfgsystem",{recorder_status:"Not installed"}),notify("recorder_plugin_na")}}):!0===i?($.post("command/recorder_cmd.php?cmd=recorder_storage_change"),$(".playback-context-menu i").removeClass("recorder-on"),$("#menu-check-recorder").css("display","none"),notify("settings_updated")):!r||"On"!=t&&"Off"!=t?"Yes"==$("#delete-recordings span").text()?($("#delete-recordings span").text("No"),$.post("command/recorder_cmd.php?cmd=recorder_delete_files",function(){notify("recorder_deleted","Updating library...")})):"Yes"==$("#tag-recordings span").text()?(notify("recorder_tagging"),$("#tag-recordings span").text("No"),$.post("command/recorder_cmd.php?cmd=recorder_tag_files",function(){notify("recorder_tagged","Updating library...")})):notify("settings_updated"):($.post("command/recorder_cmd.php?cmd=recorder_on_off"),"On"==t?($(".playback-context-menu i").addClass("recorder-on"),$("#menu-check-recorder").css("display","inline")):($(".playback-context-menu i").removeClass("recorder-on"),$("#menu-check-recorder").css("display","none")),notify("settings_updated"))})}),$("#export-stations").click(function(e){$("#import-export-msg").text("Exporting..."),e.preventDefault(),$.post("command/moode.php?cmd=export_stations",function(){window.location.href="/imagesw/stations.zip",$("#import-export-msg").text("Export complete")})}),$("#lib-coverart-img").click(function(e){UI.dbEntry[0]=$.isNumeric(UI.dbEntry[0])?UI.dbEntry[0]:0,$("#songsList li, #songsList .lib-disc a").removeClass("active"),$("img.lib-coverart").addClass("active"),$("#tracklist-toggle").hide(),$("#one-touch-action-li").show()}),$("#songsList").on("click",".lib-disc",function(e){$("img.lib-coverart, #songsList li, #songsList .lib-disc a").removeClass("active");var t=$(this).text().substr(5);for(var r in $("#lib-disc-"+t+" a").addClass("active"),filteredSongsDisc.length=0,filteredSongs)filteredSongs[r].disc==t&&filteredSongsDisc.push(filteredSongs[r])}),$("#songsList").on("click",".lib-track",function(e){UI.dbEntry[0]=$("#songsList .lib-track").index(this),$("#songsList li, #songsList .lib-disc a").removeClass("active"),$(this).addClass("active")}),$("#context-menu-playback a").click(function(e){if("save-playlist"==$(this).data("cmd"))$("#savepl-modal").modal();else if("set-favorites"==$(this).data("cmd"))$.getJSON("command/moode.php?cmd=getfavname",function(e){$("#pl-favName").val(e),$("#setfav-modal").modal()});else if("toggle-song"==$(this).data("cmd"))sendMpdCmd("playid "+toggleSongId);else if("consume"==$(this).data("cmd")){$("#menu-check-consume").toggle();var t=$(".consume").hasClass("btn-primary")?"0":"1";$(".consume").toggleClass("btn-primary"),sendMpdCmd("consume "+t)}else if("repeat"==$(this).data("cmd")){$("#menu-check-repeat").toggle();t=$(".repeat").hasClass("btn-primary")?"0":"1";$(".repeat").toggleClass("btn-primary"),sendMpdCmd("repeat "+t)}else if("single"==$(this).data("cmd")){$("#menu-check-single").toggle();t=$(".single").hasClass("btn-primary")?"0":"1";$(".single").toggleClass("btn-primary"),sendMpdCmd("single "+t)}else"stream-recorder"==$(this).data("cmd")&&($("#menu-check-recorder").toggle(),"block"==$("#menu-check-recorder").css("display")?(SESSION.json.recorder_status="On",$(".playback-context-menu i").addClass("recorder-on")):(SESSION.json.recorder_status="Off",$(".playback-context-menu i").removeClass("recorder-on")),$.post("command/moode.php?cmd=updcfgsystem",{recorder_status:SESSION.json.recorder_status},function(){$.post("command/recorder_cmd.php?cmd=recorder_on_off")}))}),$("#context-menu-lib-item a").click(function(e){$("#lib-song-"+(UI.dbEntry[0]+1).toString()).removeClass("active"),$("img.lib-coverart").removeClass("active"),"one_touch_action"==$(this).data("cmd")?oneTouchItem(filteredSongs[UI.dbEntry[0]].file):"add_item"==$(this).data("cmd")||"add_item_next"==$(this).data("cmd")?(mpdDbCmd($(this).data("cmd"),filteredSongs[UI.dbEntry[0]].file),notify("add_item")):"play_item"==$(this).data("cmd")||"play_item_next"==$(this).data("cmd")?mpdDbCmd($(this).data("cmd"),filteredSongs[UI.dbEntry[0]].file):"clear_play_item"==$(this).data("cmd")?(mpdDbCmd("clear_play_item",filteredSongs[UI.dbEntry[0]].file),notify("clear_play_item"),$("#pl-saveName").val("")):"track_info_lib"==$(this).data("cmd")&&audioinfo("track_info",filteredSongs[UI.dbEntry[0]].file)}),$("#context-menu-lib-album a").click(function(e){UI.dbEntry[0]=$.isNumeric(UI.dbEntry[0])?UI.dbEntry[0]:0,$(".album-view-button").hasClass("active")||($("#lib-song-"+(UI.dbEntry[0]+1).toString()).removeClass("active"),$("img.lib-coverart").removeClass("active"));var t=[];for(var r in filteredSongs)t.push(filteredSongs[r].file);"one_touch_action"==$(this).data("cmd")?oneTouchGroup(t):"add_group"==$(this).data("cmd")||"add_group_next"==$(this).data("cmd")?(mpdDbCmd($(this).data("cmd"),t),notify($(this).data("cmd"))):"play_group"==$(this).data("cmd")||"play_group_next"==$(this).data("cmd")?mpdDbCmd($(this).data("cmd"),t):"clear_play_group"==$(this).data("cmd")?(mpdDbCmd("clear_play_group",t),notify($(this).data("cmd"))):"tracklist"==$(this).data("cmd")&&("none"==$("#bottom-row").css("display")?($("#tracklist-toggle").html('<i class="fal fa-list sx"></i> Hide tracks'),$("#bottom-row").css("display","flex"),$("#lib-albumcover").css("height","calc(50% - env(safe-area-inset-top) - 2.75rem)"),$("#index-albumcovers").hide()):($("#tracklist-toggle").html('<i class="fal fa-list sx"></i> Show tracks'),$("#bottom-row").css("display",""),$("#lib-albumcover").css("height","100%"),$("#index-albumcovers").show()),customScroll("albumcovers",UI.libPos[1],200))}),$("#context-menu-lib-disc a").click(function(e){$("#songsList .lib-disc a").removeClass("active");var t=[];for(var r in filteredSongsDisc)t.push(filteredSongsDisc[r].file);"one_touch_action"==$(this).data("cmd")?oneTouchGroup(t):"add_group"==$(this).data("cmd")&&(mpdDbCmd("add_group",t),notify($(this).data("cmd"))),"play_group"==$(this).data("cmd")&&mpdDbCmd("play_group",t),"clear_play_group"==$(this).data("cmd")&&(mpdDbCmd("clear_play_group",t),notify($(this).data("cmd")))});
